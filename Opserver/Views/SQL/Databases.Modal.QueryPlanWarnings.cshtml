@using StackExchange.Opserver.Data.SQL
@using StackExchange.Opserver.Views.SQL
@model DatabasesModel
@{
    Layout = "Databases.Modal.cshtml";
    var s = Model.Instance;
    var queryPlanWarnings = s.GetQueryPlanWarnings(Model.Database);
}
@helper WarningSummary(SQLInstance.QueryPlanWarning i)
{
    if (i.Warnings.HasValue())
    {
        <div>
            @foreach (var warning in @i.Warnings.Split(new[] { "<sp:" }, StringSplitOptions.RemoveEmptyEntries))
            {
                <p>@String.Concat("<", warning)</p>
            }
        </div>
    }
}
@section top {
    <span class="pull-right small">@Helpers.PollNow(queryPlanWarnings)</span>
}
@if (queryPlanWarnings.Data == null || !queryPlanWarnings.Successful)
{
    <div class="alert alert-warning">
        <h5>There was an error fetching query plan warnings from @s.Name for @Model.Database</h5>
        <p class="error-stack">@queryPlanWarnings.ErrorMessage</p>
    </div>
}
else
{
    <div class="alert alert-dismissible alert-info" style="margin-bottom: 2px;">
        List of all possible iterator or query specific warnings (e.g. hash spilling, no join predicate)
    </div>
    <table class="table table-striped table-hover table-super-condensed table-responsive js-database-query-plan-warnings-log">
        <thead>
            <tr>
                <th>Object</th>
                <th>Type</th>
                <th>Ref Counts</th>
                <th>Use Counts</th>
                <th>Warnings</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var i in queryPlanWarnings.Data.OrderByDescending(b => b.UseCounts))
            {
                <tr>
                    <td><span class="text-muted">@(i.SchemaName).</span><span>@i.ObjectName</span></td>
                    <td>@i.ObjectType</td>
                    <td>@i.RefCounts</td>
                    <td>@i.UseCounts</td>
                    <td>@WarningSummary(i)</td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="7"><b>Total</b> <span class="note">(@queryPlanWarnings.Data.Count.Pluralize("query plan warning"))</span></td>
            </tr>
        </tfoot>
    </table>
    <script>
        $(function () {
            $('.js-database-query-plan-warnings-log').tablesorter();
        });
    </script>
}